{% extends "base.html" %}

{% block title %}Edit Delivery Address - Monthly Organics{% endblock %}

{% block extra_head %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
<style>
    #map {
        height: 100%;
        width: 100%;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    /* Prevent body scroll and zoom when modal is open */
    body.modal-open {
        overflow: hidden;
        touch-action: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    /* Map modal specific styles - prevent page zoom */
    #mapModal {
        touch-action: pan-x pan-y pinch-zoom;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    #mapModal #map {
        padding-top: 80px; /* Account for header */
        padding-bottom: 200px; /* Account for controls + mobile nav */
        touch-action: pan-x pan-y pinch-zoom;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    /* Ensure Google Maps container allows proper touch gestures */
    .gm-style {
        touch-action: pan-x pan-y pinch-zoom !important;
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
    }
    
    /* Prevent viewport scaling on double tap */
    #mapModal, #mapModal * {
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }
    /* Dynamic viewport height handling */
    :root {
        --app-height: 100vh;
        --app-height-dvh: 100dvh;
    }
    
    /* Map modal with stable viewport handling */
    #mapModal {
        height: var(--app-height);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /* Prevent layout shifts during browser UI transitions */
        contain: layout style paint;
        overflow: hidden;
    }
    
    /* Map container with proper height calculation */
    #mapModal #map {
        height: calc(var(--app-height) - 60px); /* Only header height, controls are fixed */
        margin-top: 60px; /* Header height */
        margin-bottom: 80px; /* Controls height for content spacing */
        /* Smooth transitions during viewport changes */
        transition: height 0.2s ease-out;
        will-change: height;
    }
    
    /* Map controls positioning - completely stable */
    .map-controls {
        position: fixed;
        bottom: env(safe-area-inset-bottom, 0px);
        left: 0;
        right: 0;
        height: 80px;
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 99999;
        /* Hardware acceleration for stable positioning */
        transform: translate3d(0, 0, 0);
        backface-visibility: hidden;
        will-change: auto;
        /* Prevent displacement during transitions */
        contain: layout style paint;
    }
    
    /* Header positioning - stable during transitions */
    #mapModal .absolute.top-0 {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        z-index: 20;
        /* Prevent movement during browser UI transitions */
        transform: translateZ(0);
        backface-visibility: hidden;
        will-change: transform;
    }
    
    @media (min-width: 768px) {
        /* Desktop adjustments */
        #mapModal #map {
            height: calc(var(--app-height) - 60px);
            margin-bottom: 60px; /* Smaller controls on desktop */
        }
        .map-controls {
            height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50">
    <div class="max-w-md mx-auto px-4 py-6">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Edit Delivery Address</h1>
            <p class="text-gray-600 text-sm mt-1">Update your delivery address details</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
                
                <!-- Auto-hide flash messages after 3 seconds -->
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const flashMessages = document.querySelectorAll('.flash-message');
                        flashMessages.forEach(function(message) {
                            setTimeout(function() {
                                message.style.transition = 'opacity 0.5s ease-out';
                                message.style.opacity = '0';
                                setTimeout(function() {
                                    message.remove();
                                }, 500);
                            }, 3000);
                        });
                    });
                </script>
            {% endif %}
        {% endwith %}

        <!-- Open Map Button -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Select Location</h3>
                <button id="changeLocationBtn" class="text-primary hover:text-primary/80 text-sm font-medium">
                    Change
                </button>
            </div>
            
            <!-- Location Status Display -->
            <div id="locationDisplay" class="mb-4">
                <div class="flex items-center space-x-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <div>
                        <div class="text-sm font-medium text-green-800">Location Selected</div>
                        <div id="selectedLocationDisplay" class="text-xs text-green-600">{{ address.locality }}, {{ address.city }} - {{ address.pincode }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Open Map Button -->
            <button id="openMapBtn" 
                    class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Select Location on Map</span>
            </button>
        </div>

        <!-- Selected Location Map Display -->
        <div id="selectedLocationMap" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Selected Location</h3>
            <div id="miniMap" style="height: 200px; width: 100%; border-radius: 8px;"></div>
            <div class="mt-3 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span id="selectedLocationText">Current location confirmed</span>
                </div>
                <button type="button" onclick="openMapModal()" class="text-primary hover:text-primary/80 text-sm font-medium">
                    Change Location
                </button>
            </div>
        </div>

        <!-- Address Form -->
        <form id="addressForm" method="POST" action="{{ url_for('update_address_for_delivery', address_id=address.id) }}" class="space-y-6">
            
            <!-- Hidden Map Data -->
            <input type="hidden" id="latitude" name="latitude" value="{{ address.latitude }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ address.longitude }}">
            
            <!-- Address Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Details</h3>
                
                <div class="space-y-4">
                    <!-- House Number (Required) -->
                    <div>
                        <label for="house_number" class="block text-sm font-medium text-gray-700 required-field">
                            House No/Plot No/Building/Community Name
                        </label>
                        <input type="text" id="house_number" name="house_number" value="{{ address.house_number }}" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Block Name (Optional) -->
                    <div>
                        <label for="block_name" class="block text-sm font-medium text-gray-700">
                            Block Name/No
                        </label>
                        <input type="text" id="block_name" name="block_name" value="{{ address.block_name or '' }}"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Floor/Door (Required) -->
                    <div>
                        <label for="floor_door" class="block text-sm font-medium text-gray-700 required-field">
                            Floor/Door Number
                        </label>
                        <input type="text" id="floor_door" name="floor_door" value="{{ address.floor_door }}" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Locality (Required, Auto-filled) -->
                    <div>
                        <label for="locality" class="block text-sm font-medium text-gray-700 required-field">
                            Locality
                        </label>
                        <input type="text" id="locality" name="locality" value="{{ address.locality }}" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- City (Auto-filled, Non-editable) -->
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">
                            City
                        </label>
                        <input type="text" id="city" name="city" value="{{ address.city }}" readonly
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- Pincode (Auto-filled, Non-editable) -->
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">
                            Pincode
                        </label>
                        <input type="text" id="pincode" name="pincode" value="{{ address.pincode }}" readonly
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- Nearby Landmark (Optional) -->
                    <div>
                        <label for="nearby_landmark" class="block text-sm font-medium text-gray-700">
                            Nearby Landmark
                        </label>
                        <input type="text" id="nearby_landmark" name="nearby_landmark" value="{{ address.nearby_landmark or '' }}"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>

            <!-- Address Label Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 required-field">Address Label</h3>
                
                <div class="space-y-4">
                    <!-- Manual Label Input -->
                    <div>
                        <label for="custom_label" class="block text-sm font-medium text-gray-700 required-field">
                            Enter Address Label
                        </label>
                        <input type="text" id="custom_label" name="custom_label" value="{{ address.nickname }}" required
                               placeholder="e.g., Home, Office, Friend's Place, etc."
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Hidden nickname field that gets populated -->
                    <input type="hidden" id="nickname" name="nickname" value="{{ address.nickname }}">
                </div>
            </div>

            <!-- Receiver Details Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Receiver Details</h3>
                
                <div class="space-y-4">
                    <!-- Receiver Name (Required) -->
                    <div>
                        <label for="receiver_name" class="block text-sm font-medium text-gray-700 required-field">
                            Receiver's Name
                        </label>
                        <div class="mt-1 relative">
                            <input type="text" id="receiver_name" name="receiver_name" required
                                   value="{{ address.receiver_name if address.receiver_name and address.receiver_name != 'Customer' else '' }}"
                                   class="block w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:ring-primary focus:border-primary">
                            <button type="button" id="contactsBtn" 
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Receiver Phone (Required) -->
                    <div>
                        <label for="contact_number" class="block text-sm font-medium text-gray-700 required-field">
                            Receiver's Phone Number
                        </label>
                        <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10}" required
                               value="{{ address.contact_number or '' }}"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Address Notes -->
                    <div>
                        <label for="address_notes" class="block text-sm font-medium text-gray-700">
                            Address Notes (Optional)
                        </label>
                        <textarea id="address_notes" name="address_notes" rows="3" 
                                  class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary"
                                  placeholder="Any additional delivery instructions...">{{ address.address_notes or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div class="space-y-3">
                    <button type="submit" 
                            name="action"
                            value="update_and_use"
                            class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                        Update & Use This Address
                    </button>
                    <button type="button" 
                            onclick="discardChangesAndUse()"
                            class="w-full bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium border border-gray-300">
                        Discard Changes & Use Original
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Full Screen Map Modal -->
<div id="mapModal" class="fixed inset-0 bg-white z-50 hidden overflow-hidden">
    <!-- Map Header -->
    <div class="absolute top-0 left-0 right-0 bg-white shadow-sm border-b border-gray-200 z-10">
        <div class="flex items-center justify-between p-4">
            <h3 class="text-lg font-semibold text-gray-900">Select Location</h3>
            <button id="closeMapBtn" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Full Screen Map -->
    <div id="map" class="w-full h-full"></div>
    
    <!-- Map Controls - Fixed at bottom -->
    <div class="absolute left-0 right-0 bg-white shadow-lg border-t border-gray-200 p-4 z-10 map-controls">
        <!-- Location Status -->
        <div id="locationStatus" class="text-sm text-gray-600 mb-4 text-center">
            Tap on the map to select your location or use current location
        </div>
        
        <!-- Control Buttons -->
        <div class="flex space-x-2">
            <button id="getCurrentLocation" 
                    class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Current Location</span>
            </button>
            <button id="confirmLocation" 
                    class="flex-1 bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors font-medium" 
                    style="display: none;">
                Confirm Location
            </button>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let miniMap;
let selectedLocation;
let geocoder;

// Dynamic viewport height handler for mobile browser UI
function setViewportHeight() {
    // Use visual viewport for most accurate height during browser UI transitions
    const height = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--app-height', `${height}px`);
    
    // Update controls positioning if map modal is open
    if (document.getElementById('mapModal') && !document.getElementById('mapModal').classList.contains('hidden')) {
        const controls = document.querySelector('.map-controls');
        if (controls) {
            // Ensure controls stay at the bottom during transitions
            controls.style.bottom = `${window.visualViewport ? 0 : 0}px`;
        }
        
        // Trigger map resize after viewport change
        const mapElement = document.getElementById('map');
        if (mapElement && window.google && window.google.maps && map) {
            setTimeout(() => {
                google.maps.event.trigger(map, 'resize');
            }, 50); // Faster response
        }
    }
}

// Initialize viewport height and add listeners
function initializeViewportHandler() {
    setViewportHeight();
    
    // Debounced viewport update to prevent excessive calls
    let resizeTimer;
    let isTransitioning = false;
    
    function debouncedViewportUpdate() {
        if (isTransitioning) return;
        isTransitioning = true;
        
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            setViewportHeight();
            isTransitioning = false;
        }, 50); // Faster response for smoother transitions
    }
    
    // Handle window resize events
    window.addEventListener('resize', debouncedViewportUpdate, { passive: true });
    
    // Handle orientation changes with longer delay
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            setViewportHeight();
        }, 300);
    }, { passive: true });
    
    // Handle visual viewport changes (mobile browser UI) - most important for our case
    if ('visualViewport' in window) {
        window.visualViewport.addEventListener('resize', debouncedViewportUpdate, { passive: true });
        window.visualViewport.addEventListener('scroll', debouncedViewportUpdate, { passive: true });
    }
    
    // Handle scroll events that might trigger browser UI changes
    let scrollTimer;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(setViewportHeight, 100);
    }, { passive: true });
}

function initializeMap() {
    geocoder = new google.maps.Geocoder();
    
    // Initialize viewport handler first
    initializeViewportHandler();
    
    const existingLocation = { 
        lat: {{ address.latitude }}, 
        lng: {{ address.longitude }} 
    };
    selectedLocation = existingLocation;
    
    // Initialize main map (hidden initially) - defaults to Hyderabad if no existing location
    const defaultCenter = existingLocation.lat !== 0 ? existingLocation : { lat: 17.3850, lng: 78.4867 };
    map = new google.maps.Map(document.getElementById('map'), {
        center: defaultCenter,
        zoom: 16,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        gestureHandling: 'greedy'
    });

    // Add click listener to map
    map.addListener('click', function(event) {
        setMarkerPosition(event.latLng);
    });
    
    // Initialize mini map with existing location
    initializeMiniMap();
}

function initializeMiniMap() {
    setTimeout(() => {
        miniMap = new google.maps.Map(document.getElementById('miniMap'), {
            center: selectedLocation,
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: false,
            gestureHandling: 'none'
        });
        
        new google.maps.Marker({
            position: selectedLocation,
            map: miniMap
        });
    }, 100);
}

function openMapModal() {
    document.getElementById('mapModal').classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Resize map and set existing marker
    setTimeout(() => {
        google.maps.event.trigger(map, 'resize');
        // Force enable single-finger gestures
        map.setOptions({ 
            gestureHandling: 'greedy',
            disableDefaultUI: false,
            zoomControl: true,
            scaleControl: false,
            streetViewControl: false,
            rotateControl: false,
            fullscreenControl: false
        });
        map.setCenter(selectedLocation);
        map.setZoom(16);
        
        // Set existing marker
        if (marker) {
            marker.setMap(null);
        }
        marker = new google.maps.Marker({
            position: selectedLocation,
            map: map,
            draggable: true
        });
        
        marker.addListener('dragend', function() {
            updateSelectedLocation(marker.getPosition());
        });
        
        document.getElementById('locationStatus').textContent = 
            `Current: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        document.getElementById('confirmLocation').style.display = 'block';
    }, 100);
}

function closeMapModal() {
    document.getElementById('mapModal').classList.add('hidden');
    document.body.classList.remove('modal-open');
}

function setMarkerPosition(latLng) {
    if (marker) {
        marker.setMap(null);
    }
    
    marker = new google.maps.Marker({
        position: latLng,
        map: map,
        draggable: true
    });
    
    marker.addListener('dragend', function() {
        updateSelectedLocation(marker.getPosition());
    });
    
    updateSelectedLocation(latLng);
    document.getElementById('confirmLocation').style.display = 'block';
}

function updateSelectedLocation(latLng) {
    selectedLocation = latLng;
    document.getElementById('latitude').value = latLng.lat();
    document.getElementById('longitude').value = latLng.lng();
    
    // Update status
    document.getElementById('locationStatus').textContent = 
        `Selected: ${latLng.lat().toFixed(6)}, ${latLng.lng().toFixed(6)}`;
    
    // Reverse geocode to get address
    geocoder.geocode({ location: latLng }, function(results, status) {
        if (status === 'OK' && results[0]) {
            parseAddressComponents(results[0]);
        }
    });
}

function parseAddressComponents(result) {
    const components = result.address_components;
    let locality = '';
    let city = '';
    let pincode = '';
    
    components.forEach(component => {
        const types = component.types;
        if (types.includes('sublocality_level_1') || types.includes('neighborhood')) {
            locality = component.long_name;
        } else if (types.includes('locality')) {
            city = component.long_name;
        } else if (types.includes('postal_code')) {
            pincode = component.long_name;
        }
    });
    
    // Update form fields
    document.getElementById('locality').value = locality;
    document.getElementById('city').value = city;
    document.getElementById('pincode').value = pincode;
    
    // Update display
    document.getElementById('selectedLocationDisplay').textContent = 
        `${locality}, ${city} - ${pincode}`;
}

function confirmLocationSelection() {
    if (!selectedLocation) return;
    
    closeMapModal();
    
    // Update mini map
    if (miniMap) {
        miniMap.setCenter(selectedLocation);
        // Clear existing markers and add new one
        miniMap = new google.maps.Map(document.getElementById('miniMap'), {
            center: selectedLocation,
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: false,
            gestureHandling: 'none'
        });
        
        new google.maps.Marker({
            position: selectedLocation,
            map: miniMap
        });
    }
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        document.getElementById('locationStatus').textContent = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLocation = new google.maps.LatLng(
                    position.coords.latitude,
                    position.coords.longitude
                );
                
                map.setCenter(userLocation);
                map.setZoom(16);
                setMarkerPosition(userLocation);
            },
            function(error) {
                document.getElementById('locationStatus').textContent = 
                    'Unable to get location. Please select manually on the map.';
            }
        );
    } else {
        document.getElementById('locationStatus').textContent = 
            'Geolocation not supported. Please select manually on the map.';
    }
}

function discardChangesAndUse() {
    // Redirect back to delivery fee calculation with the original address selected
    window.location.href = "{{ url_for('delivery_fee_calculation') }}?address_id={{ address.id }}";
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    
    // Map modal controls
    document.getElementById('openMapBtn').addEventListener('click', openMapModal);
    document.getElementById('changeLocationBtn').addEventListener('click', openMapModal);
    document.getElementById('closeMapBtn').addEventListener('click', closeMapModal);
    document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);
    document.getElementById('confirmLocation').addEventListener('click', confirmLocationSelection);
    
    // Form validation
    document.getElementById('custom_label').addEventListener('input', function() {
        document.getElementById('nickname').value = this.value;
    });
});
</script>
{% endblock %}