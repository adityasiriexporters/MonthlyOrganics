{% extends "admin/admin_base.html" %}

{% block title %}Zoho Integration - Admin{% endblock %}

{% block extra_head %}
<style>
.status-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.sync-card {
    transition: all 0.3s ease;
}

.sync-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.status-badge {
    @apply px-3 py-1 rounded-full text-sm font-medium;
}

.status-connected {
    @apply bg-green-100 text-green-800;
}

.status-disconnected {
    @apply bg-red-100 text-red-800;
}

.progress-bar {
    background: linear-gradient(90deg, #4ade80, #22c55e);
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Zoho Integration</h1>
                <p class="text-gray-600 mt-2">Manage synchronization with Zoho Inventory</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="refreshStatus()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-refresh mr-2"></i>Refresh Status
                </button>
            </div>
        </div>
    </div>

    <!-- Connection Status Card -->
    <div class="mb-8">
        <div class="status-card rounded-lg p-6 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold mb-2">Connection Status</h2>
                    <div class="flex items-center space-x-3">
                        <span class="status-badge {{ 'status-connected' if sync_status.connected else 'status-disconnected' }}">
                            {{ 'Connected' if sync_status.connected else 'Disconnected' }}
                        </span>
                        {% if sync_status.connected %}
                            <span class="text-green-100">
                                <i class="fas fa-check-circle"></i> Ready for synchronization
                            </span>
                        {% else %}
                            <span class="text-red-100">
                                <i class="fas fa-exclamation-circle"></i> Authentication required
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% if not sync_status.connected %}
                    <a href="{{ url_for('admin.zoho_auth') }}" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                        <i class="fas fa-link mr-2"></i>Connect to Zoho
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sync Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Products Sync Status -->
        <div class="sync-card bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Product Synchronization</h3>
                <i class="fas fa-box text-blue-500 text-xl"></i>
            </div>
            
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total Products:</span>
                    <span class="font-medium">{{ sync_status.products.total }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Mapped to Zoho:</span>
                    <span class="font-medium text-blue-600">{{ sync_status.products.mapped }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Successfully Synced:</span>
                    <span class="font-medium text-green-600">{{ sync_status.products.synced }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Sync Errors:</span>
                    <span class="font-medium text-red-600">{{ sync_status.products.errors }}</span>
                </div>
            </div>
            
            <!-- Progress Bar -->
            {% if sync_status.products.total > 0 %}
            <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Sync Progress</span>
                    <span>{{ "%.1f"|format((sync_status.products.synced / sync_status.products.total) * 100) }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar h-2 rounded-full" style="width: {{ (sync_status.products.synced / sync_status.products.total) * 100 }}%"></div>
                </div>
            </div>
            {% endif %}
            
            <div class="flex space-x-2 mt-6">
                <button onclick="syncProductsToZoho()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-sm transition-colors" {{ 'disabled' if not sync_status.connected else '' }}>
                    <i class="fas fa-upload mr-1"></i>Sync to Zoho
                </button>
                <button onclick="importProductsFromZoho()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded text-sm transition-colors" {{ 'disabled' if not sync_status.connected else '' }}>
                    <i class="fas fa-download mr-1"></i>Import from Zoho
                </button>
            </div>
        </div>

        <!-- Sales Orders Sync Status -->
        <div class="sync-card bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Sales Order Synchronization</h3>
                <i class="fas fa-shopping-cart text-green-500 text-xl"></i>
            </div>
            
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total Synced Orders:</span>
                    <span class="font-medium">{{ sync_status.orders.total_synced }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Successful Syncs:</span>
                    <span class="font-medium text-green-600">{{ sync_status.orders.successful }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Failed Syncs:</span>
                    <span class="font-medium text-red-600">{{ sync_status.orders.failed }}</span>
                </div>
            </div>
            
            <!-- Order Sync Progress -->
            {% if sync_status.orders.total_synced > 0 %}
            <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Success Rate</span>
                    <span>{{ "%.1f"|format((sync_status.orders.successful / sync_status.orders.total_synced) * 100) }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar h-2 rounded-full" style="width: {{ (sync_status.orders.successful / sync_status.orders.total_synced) * 100 }}%"></div>
                </div>
            </div>
            {% endif %}
            
            <div class="mt-6">
                <p class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Orders are automatically synced to Zoho when placed by customers.
                </p>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Integration Information</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <i class="fas fa-sync-alt text-blue-500 text-2xl mb-2"></i>
                <h4 class="font-medium text-gray-900">Automatic Sync</h4>
                <p class="text-sm text-gray-600 mt-1">New orders are automatically sent to Zoho Inventory as sales orders</p>
            </div>
            
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <i class="fas fa-warehouse text-green-500 text-2xl mb-2"></i>
                <h4 class="font-medium text-gray-900">Inventory Management</h4>
                <p class="text-sm text-gray-600 mt-1">Keep your local products in sync with Zoho Inventory items</p>
            </div>
            
            <div class="text-center p-4 bg-purple-50 rounded-lg">
                <i class="fas fa-chart-line text-purple-500 text-2xl mb-2"></i>
                <h4 class="font-medium text-gray-900">Reporting</h4>
                <p class="text-sm text-gray-600 mt-1">Generate comprehensive reports using Zoho's analytics tools</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p class="text-gray-700">Processing...</p>
    </div>
</div>

<script>
// Show/hide loading overlay
function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.getElementById('loadingOverlay').classList.add('flex');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('loadingOverlay').classList.remove('flex');
}

// Show toast messages
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    } text-white`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Refresh status
async function refreshStatus() {
    try {
        showLoading();
        const response = await fetch('/admin/zoho/status');
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            showToast('Failed to refresh status', 'error');
        }
    } catch (error) {
        showToast('Error refreshing status', 'error');
    } finally {
        hideLoading();
    }
}

// Sync products to Zoho
async function syncProductsToZoho() {
    if (!confirm('This will sync all local products to Zoho Inventory. Continue?')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch('/admin/zoho/sync-products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(data.error || 'Sync failed', 'error');
        }
    } catch (error) {
        showToast('Error during sync', 'error');
    } finally {
        hideLoading();
    }
}

// Import products from Zoho
async function importProductsFromZoho() {
    if (!confirm('This will import all items from Zoho Inventory as local products. Continue?')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch('/admin/zoho/import-products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(data.error || 'Import failed', 'error');
        }
    } catch (error) {
        showToast('Error during import', 'error');
    } finally {
        hideLoading();
    }
}
</script>
{% endblock %}