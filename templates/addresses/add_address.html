{% extends "base.html" %}

{% block title %}Add New Address - Monthly Organics{% endblock %}

{% block extra_head %}
<!-- Google Maps JavaScript API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry,places,marker"></script>
<!-- Maps Fix for Single Pin Management -->
<script src="{{ url_for('static', filename='js/maps-fix.js') }}"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-background" x-data="addressForm()">
    <!-- Header - Always visible and fixed -->
    <div class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-30">
        <div class="max-w-md mx-auto px-4 py-4">
            <div class="flex items-center space-x-3">
                <a href="{{ url_for('addresses.addresses') }}" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-xl font-semibold text-gray-900" x-show="locationConfirmed">Add New Address</h1>
                <h1 class="text-xl font-semibold text-gray-900" x-show="!locationConfirmed">Select Location</h1>
            </div>
        </div>
    </div>

    <!-- Map Container (Full Screen when active) -->
    <div id="map-container" class="fixed inset-0 z-20" x-show="!locationConfirmed" style="top: 64px; bottom: 64px;">
        <div id="map" class="w-full h-full"></div>
        
        <!-- Map Control Buttons - Fixed above footer -->
        <div class="absolute bottom-4 left-4 right-4 z-10">
            <div class="flex space-x-3">
                <button @click="detectCurrentLocation()" 
                        class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2 shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>Detect Current Location</span>
                </button>
                
                <button @click="confirmLocation()" 
                        x-show="selectedLocation"
                        class="flex-1 bg-primary text-white py-3 px-4 rounded-lg font-medium hover:bg-primary/90 transition-colors flex items-center justify-center space-x-2 shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Confirm Location</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Form Container -->
    <div x-show="locationConfirmed" x-transition class="max-w-md mx-auto pt-16 pb-20">
        <!-- Small Map Preview -->
        <div class="relative bg-gray-100">
            <div id="map-preview" class="w-full h-48"></div>
            <button @click="changeLocation()" 
                    class="absolute top-3 right-3 bg-white text-gray-700 px-3 py-1 rounded-md text-sm font-medium shadow-sm hover:bg-gray-50 transition-colors">
                Change Location
            </button>
        </div>

        <!-- Address Form -->
        <form @submit.prevent="saveAddress()" class="p-4 space-y-6">
            <!-- Address Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Details</h3>
                
                <div class="space-y-4">
                    <!-- House/Plot/Building -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            House No/Plot No/Building/Community Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               x-model="formData.house_no"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="Enter house/building details"
                               required>
                    </div>

                    <!-- Block Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Block Name/No</label>
                        <input type="text" 
                               x-model="formData.block_name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="Enter block details (optional)">
                    </div>

                    <!-- Floor/Door -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Floor/Door Number <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               x-model="formData.floor_door"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="e.g., 2nd Floor, Flat 201"
                               required>
                    </div>

                    <!-- Locality (auto-filled from map) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Locality</label>
                        <input type="text" 
                               x-model="formData.locality"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="Auto-filled from map">
                    </div>

                    <!-- City (auto-filled, non-editable) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <input type="text" 
                               x-model="formData.city"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-600"
                               placeholder="Auto-filled from map"
                               readonly>
                    </div>

                    <!-- Pincode (auto-filled, non-editable) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                        <input type="text" 
                               x-model="formData.pincode"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-600"
                               placeholder="Auto-filled from map"
                               readonly>
                    </div>

                    <!-- Landmark -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nearby Landmark</label>
                        <input type="text" 
                               x-model="formData.landmark"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="e.g., Near Metro Station">
                    </div>
                </div>
            </div>

            <!-- Address Label Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Label</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Address Label <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           x-model="formData.address_label"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                           placeholder="e.g., Home, Office, Friend's Home"
                           required>
                </div>
            </div>

            <!-- Receiver Information Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Receiver's Information</h3>
                
                <div class="space-y-4">
                    <!-- Receiver Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Receiver's Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               x-model="formData.receiver_name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="Enter receiver's full name"
                               required>
                    </div>

                    <!-- Receiver Phone -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Receiver's Phone Number <span class="text-red-500">*</span>
                        </label>
                        <input type="tel" 
                               x-model="formData.receiver_phone"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary"
                               placeholder="Enter 10-digit phone number"
                               pattern="[6-9][0-9]{9}"
                               required>
                    </div>
                </div>
            </div>

            <!-- Set as Default -->
            <div class="flex items-center space-x-3">
                <input type="checkbox" 
                       x-model="formData.is_default"
                       id="is_default"
                       class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="is_default" class="text-sm font-medium text-gray-700">
                    Set as default address
                </label>
            </div>

            <!-- Save Button -->
            <button type="submit" 
                    class="w-full bg-primary text-white py-3 px-4 rounded-lg font-medium hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    :disabled="saving">
                <span x-show="!saving">Save Address</span>
                <span x-show="saving">Saving...</span>
            </button>
        </form>
    </div>
</div>

<script>
function addressForm() {
    return {
        map: null,
        pinManager: null,
        previewMap: null,
        previewMarker: null,
        selectedLocation: null,
        locationConfirmed: false,
        saving: false,
        mapInitialized: false,
        formData: {
            house_no: '',
            block_name: '',
            floor_door: '',
            locality: '',
            city: '',
            pincode: '',
            landmark: '',
            address_label: '',
            receiver_name: '',
            receiver_phone: '',
            is_default: false
        },

        init() {
            // Only initialize map once
            if (!this.mapInitialized) {
                this.initMap();
                this.mapInitialized = true;
            }
        },

        initMap() {
            // Clean up existing resources
            if (this.pinManager) {
                this.pinManager.destroy();
            }
            
            // Initialize full-screen map
            const defaultLocation = { lat: 28.6139, lng: 77.2090 }; // Delhi as default
            
            this.map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: defaultLocation,
                disableDefaultUI: true,
                zoomControl: true,
                gestureHandling: 'greedy',
                clickableIcons: false,
                disableDoubleClickZoom: false,
                mapId: 'monthly-organics-map' // Required for AdvancedMarkerElement
            });

            // Initialize single pin manager
            this.pinManager = new window.SinglePinManager(this.map);

            // Add click listener through pin manager
            this.pinManager.addClickListener((latLng) => {
                this.setMarker(latLng);
            });
        },

        setMarker(location) {
            // Use pin manager to ensure single pin
            this.pinManager.setMarker(location, (event) => {
                // Drag end callback - handle both AdvancedMarkerElement and legacy Marker
                let dragLatLng;
                if (event.latLng) {
                    // Legacy Marker event structure
                    dragLatLng = event.latLng;
                } else if (this.pinManager.currentMarker && this.pinManager.currentMarker.position) {
                    // AdvancedMarkerElement - get position directly
                    dragLatLng = this.pinManager.currentMarker.position;
                } else {
                    console.error('Unable to get drag position');
                    return;
                }

                this.selectedLocation = {
                    lat: dragLatLng.lat(),
                    lng: dragLatLng.lng()
                };
                this.reverseGeocode(dragLatLng);
            });

            // Update selected location
            this.selectedLocation = {
                lat: location.lat(),
                lng: location.lng()
            };

            // Get address from coordinates
            this.reverseGeocode(location);
        },

        detectCurrentLocation() {
            if (navigator.geolocation) {
                // Show loading state (you can add a loading indicator here)
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        // Center map on current location
                        this.map.setCenter(location);
                        this.map.setZoom(17); // Zoom in for better accuracy
                        
                        // Place marker at current location
                        this.setMarker(new google.maps.LatLng(location.lat, location.lng));
                    },
                    (error) => {
                        let errorMessage = 'Error getting current location: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Location access denied. You can still place the pin manually on the map.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Location information unavailable. You can still place the pin manually on the map.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Location request timed out. You can still place the pin manually on the map.';
                                break;
                            default:
                                errorMessage += 'Unknown error occurred. You can still place the pin manually on the map.';
                                break;
                        }
                        alert(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser. You can still place the pin manually on the map.');
            }
        },

        reverseGeocode(location) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const addressComponents = results[0].address_components;
                    
                    // Parse address components
                    let locality = '';
                    let city = '';
                    let pincode = '';
                    
                    addressComponents.forEach(component => {
                        const types = component.types;
                        if (types.includes('sublocality') || types.includes('neighborhood')) {
                            locality = component.long_name;
                        } else if (types.includes('locality') || types.includes('administrative_area_level_2')) {
                            city = component.long_name;
                        } else if (types.includes('postal_code')) {
                            pincode = component.long_name;
                        }
                    });
                    
                    // Update form data
                    this.formData.locality = locality;
                    this.formData.city = city;
                    this.formData.pincode = pincode;
                }
            });
        },

        confirmLocation() {
            if (!this.selectedLocation) {
                alert('Please select a location on the map');
                return;
            }
            
            this.locationConfirmed = true;
            
            // Initialize preview map
            this.$nextTick(() => {
                this.initPreviewMap();
            });
        },

        initPreviewMap() {
            this.previewMap = new google.maps.Map(document.getElementById('map-preview'), {
                zoom: 16,
                center: this.selectedLocation,
                disableDefaultUI: true,
                gestureHandling: 'none'
            });

            // Use standard Marker for preview (simpler, doesn't need advanced features)
            this.previewMarker = new google.maps.Marker({
                position: this.selectedLocation,
                map: this.previewMap,
                title: 'Selected Location',
                draggable: false
            });
        },

        changeLocation() {
            this.locationConfirmed = false;
            
            // Re-center map on existing location if available
            if (this.selectedLocation) {
                this.map.setCenter(this.selectedLocation);
                this.map.setZoom(15);
                
                // Ensure marker exists at the selected location
                this.$nextTick(() => {
                    if (!this.pinManager.hasMarker()) {
                        this.setMarker(new google.maps.LatLng(this.selectedLocation.lat, this.selectedLocation.lng));
                    }
                });
            }
        },

        async saveAddress() {
            if (!this.selectedLocation) {
                alert('Please select a location on the map');
                return;
            }

            // Validate required fields
            const requiredFields = ['house_no', 'floor_door', 'address_label', 'receiver_name', 'receiver_phone'];
            for (let field of requiredFields) {
                if (!this.formData[field].trim()) {
                    const fieldElement = document.querySelector(`input[x-model="formData.${field}"]`);
                    fieldElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    fieldElement.focus();
                    alert('Please fill all mandatory fields');
                    return;
                }
            }

            this.saving = true;

            try {
                const addressData = {
                    ...this.formData,
                    latitude: this.selectedLocation.lat,
                    longitude: this.selectedLocation.lng
                };

                const response = await fetch('{{ url_for('addresses.save_address') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(addressData)
                });

                if (response.ok) {
                    window.location.href = '{{ url_for('addresses.addresses') }}';
                } else {
                    const error = await response.text();
                    alert('Error saving address: ' + error);
                }
            } catch (error) {
                alert('Error saving address: ' + error.message);
            } finally {
                this.saving = false;
            }
        }
    };
}
</script>
{% endblock %}