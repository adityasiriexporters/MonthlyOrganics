<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pre-Checkout - Monthly Organics</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- htmx CDN -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2C7A3C',
                        secondary: '#402D1C',
                        background: '#F9F1E5'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background text-gray-800 antialiased h-screen overflow-hidden">
<div class="h-screen bg-gray-50 flex flex-col">
    <!-- Header - Same as Store Page -->
    <header class="flex-shrink-0 bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-md mx-auto flex items-center justify-between p-4">
            <!-- Logo Only (Left) -->
            <div class="flex items-center flex-shrink-0">
                <img src="{{ url_for('static', filename='img/icononly_transparent_nobuffer.png') }}" 
                     alt="Monthly Organics Logo" 
                     class="h-10 w-auto">
            </div>
            
            <!-- Brand Name with Font Style (Right) -->
            <div class="flex items-center flex-1 justify-end">
                <img src="{{ url_for('static', filename='img/brand_name_with_font.png') }}" 
                     alt="Monthly Organics" 
                     class="h-8 w-auto max-w-full">
            </div>
        </div>
    </header>

    <!-- Scrollable Main Content -->
    <div class="flex-1 overflow-y-auto">
        <div class="max-w-md mx-auto">
        <!-- Page Header with Go Back -->
        <div class="bg-white shadow-sm mb-4">
            <div class="p-4">
                <div class="flex items-center space-x-3">
                    <a href="{{ url_for('cart') }}" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </a>
                    <h1 class="text-lg font-semibold text-gray-900">Delivery Address</h1>
                </div>
            </div>
        </div>
        <!-- Address Selection Section -->
        <div class="bg-white shadow-sm">
            <div class="p-4">
                <h2 class="font-medium text-gray-900 mb-3">Select Delivery Address</h2>
                
                <div class="mb-4">
                    <select id="address-dropdown" 
                            class="w-full border border-gray-300 rounded-lg px-3 py-3 text-sm focus:ring-2 focus:ring-primary focus:border-primary bg-white"
                            onchange="handleAddressSelection()">
                        <option value="add_new">+ Add New Address</option>
                        {% for address in addresses %}
                            <option value="{{ address.id }}" 
                                    data-address="{{ address.id }}"
                                    {% if address.is_default %}selected{% endif %}>
                                {{ address.nickname }} - {{ address.locality }}, {{ address.city }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Edit Address Option for Selected Address -->
                <div id="edit-address-section" class="hidden">
                    <button onclick="editSelectedAddress()" 
                            class="text-primary text-sm underline hover:no-underline">
                        Edit this address
                    </button>
                </div>
            </div>
        </div>

        <!-- Address Confirmation Section -->
        <div id="address-confirmation" class="bg-white shadow-sm mt-4 {% if not addresses or not addresses|selectattr('is_default')|list %}hidden{% endif %}">
            <div class="p-4">
                <h2 class="font-medium text-gray-900 mb-4">Address Confirmation</h2>
                
                <!-- Map Container -->
                <div id="confirmation-map" class="w-full h-48 bg-gray-100 rounded-lg mb-4 border">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="text-sm">Location Map</span>
                    </div>
                </div>

                <!-- Address Details -->
                <div id="address-details" class="space-y-2 mb-4">
                    <!-- Address details will be populated by JavaScript -->
                </div>

                <!-- Confirmation Checkbox -->
                <div class="flex items-start space-x-2 mb-4">
                    <input type="checkbox" 
                           id="address-confirm-checkbox" 
                           class="mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2"
                           onchange="toggleConfirmButton()">
                    <label for="address-confirm-checkbox" class="text-sm text-gray-700">
                        I confirm this is the correct delivery address
                    </label>
                </div>

                <!-- Confirm Address Button -->
                <button id="confirm-address-btn" 
                        onclick="confirmAddress()"
                        disabled
                        class="w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed disabled:opacity-50 transition-all">
                    Confirm Address
                </button>
            </div>
        </div>

        <!-- No Addresses Message -->
        {% if not addresses %}
        <div class="bg-white shadow-sm mt-4">
            <div class="text-center py-8 px-4">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No saved addresses</h3>
                <p class="text-sm text-gray-500 mb-4">Please add a delivery address to continue with checkout</p>
                
                <a href="{{ url_for('add_new_address_for_delivery') }}" 
                   class="inline-block bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors">
                    Add Delivery Address
                </a>
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    <!-- Mobile Navigation Bar -->
    <nav class="flex-shrink-0 bg-white border-t border-gray-200 md:hidden">
        <div class="max-w-md mx-auto">
            <div class="flex items-center justify-around py-2">
                <!-- Home -->
                <a href="/" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="text-xs font-medium">Home</span>
                </a>
                <!-- Store -->
                <a href="/store" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span class="text-xs font-medium">Store</span>
                </a>
                <!-- Cart -->
                <a href="/cart" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m-2.4-5L3 3m0 0h.01M7 13v6a2 2 0 002 2h6a2 2 0 002-2v-6m-8 2h.01M15 15h.01"></path>
                    </svg>
                    <span class="text-xs font-medium">Cart</span>
                </a>
                <!-- Profile -->
                <a href="/profile" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="text-xs font-medium">Profile</span>
                </a>
            </div>
        </div>
    </nav>
</div>

<!-- Include Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>

<script>
// Store addresses data for JavaScript access
const addressesData = {{ addresses_json|safe }};
let confirmationMap = null;
let selectedAddressId = null;

// Initialize with default address if available
document.addEventListener('DOMContentLoaded', function() {
    const dropdown = document.getElementById('address-dropdown');
    const defaultAddress = addressesData.find(addr => addr.is_default);
    
    if (defaultAddress) {
        dropdown.value = defaultAddress.id;
        selectedAddressId = defaultAddress.id;
        showAddressConfirmation(defaultAddress);
    }
});

function handleAddressSelection() {
    const dropdown = document.getElementById('address-dropdown');
    const selectedValue = dropdown.value;
    
    if (selectedValue === 'add_new') {
        // Redirect to add new address page
        window.location.href = "{{ url_for('add_new_address_for_delivery') }}";
        return;
    }
    
    selectedAddressId = parseInt(selectedValue);
    const selectedAddress = addressesData.find(addr => addr.id === selectedAddressId);
    
    if (selectedAddress) {
        showAddressConfirmation(selectedAddress);
        document.getElementById('edit-address-section').classList.remove('hidden');
    }
}

function showAddressConfirmation(address) {
    // Show the confirmation section
    document.getElementById('address-confirmation').classList.remove('hidden');
    
    // Populate address details
    const detailsContainer = document.getElementById('address-details');
    detailsContainer.innerHTML = `
        <div class="border-b border-gray-100 pb-2 mb-2">
            <h3 class="font-semibold text-gray-900 text-lg">${address.nickname}</h3>
        </div>
        <div class="space-y-1 text-sm text-gray-700">
            <p><span class="font-medium">House/Building:</span> ${address.house_number}</p>
            ${address.block_name ? `<p><span class="font-medium">Block:</span> ${address.block_name}</p>` : ''}
            ${address.floor_door ? `<p><span class="font-medium">Floor/Door:</span> ${address.floor_door}</p>` : ''}
            <p><span class="font-medium">Locality:</span> ${address.locality}</p>
            <p><span class="font-medium">Pincode:</span> ${address.pincode}</p>
        </div>
        <div class="border-t border-gray-100 pt-2 mt-3">
            <p class="font-semibold text-gray-900 text-base">${address.receiver_name}</p>
            <p class="font-semibold text-gray-900">${address.contact_number}</p>
        </div>
    `;
    
    // Initialize map with the address location
    initConfirmationMap(address.latitude, address.longitude);
    
    // Reset checkbox and button
    document.getElementById('address-confirm-checkbox').checked = false;
    toggleConfirmButton();
}

function initConfirmationMap(lat, lng) {
    const mapElement = document.getElementById('confirmation-map');
    
    if (confirmationMap) {
        confirmationMap = null;
    }
    
    confirmationMap = new google.maps.Map(mapElement, {
        center: { lat: parseFloat(lat), lng: parseFloat(lng) },
        zoom: 16,
        disableDefaultUI: true,
        zoomControl: true,
        gestureHandling: 'none' // Disable interaction
    });
    
    // Add marker
    new google.maps.Marker({
        position: { lat: parseFloat(lat), lng: parseFloat(lng) },
        map: confirmationMap,
        title: 'Delivery Location'
    });
}

function editSelectedAddress() {
    if (selectedAddressId) {
        window.location.href = `/edit-address-for-delivery/${selectedAddressId}`;
    }
}

function toggleConfirmButton() {
    const checkbox = document.getElementById('address-confirm-checkbox');
    const button = document.getElementById('confirm-address-btn');
    
    if (checkbox.checked) {
        button.disabled = false;
        button.className = 'w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors cursor-pointer';
        button.textContent = 'Confirm Address';
    } else {
        button.disabled = true;
        button.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed disabled:opacity-50 transition-all';
        button.textContent = 'Confirm Address';
    }
}

function confirmAddress() {
    if (selectedAddressId && document.getElementById('address-confirm-checkbox').checked) {
        // Proceed to checkout with selected address
        window.location.href = `/checkout?address_id=${selectedAddressId}`;
    }
}
</script>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="fixed bottom-4 left-4 right-4 z-50">
            {% for category, message in messages %}
                <div class="bg-white rounded-lg shadow-lg border p-4 mb-2 max-w-md mx-auto
                    {% if category == 'error' %}border-red-200{% else %}border-green-200{% endif %}">
                    <div class="flex items-center space-x-2">
                        {% if category == 'error' %}
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        {% else %}
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        {% endif %}
                        <span class="text-sm {% if category == 'error' %}text-red-700{% else %}text-green-700{% endif %}">{{ message }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}



</body>
</html>