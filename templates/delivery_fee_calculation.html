<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Fee Calculation - Monthly Organics</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Calculate delivery fees for your organic produce order - Monthly Organics">
    <meta name="keywords" content="delivery fee, organic produce, checkout, Monthly Organics">
    
    <!-- Favicon and Touch Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}">
    
    <!-- External CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom CSS -->
    <style>
        .primary { --tw-text-opacity: 1; color: rgb(34 197 94 / var(--tw-text-opacity)); }
        .bg-primary { --tw-bg-opacity: 1; background-color: rgb(34 197 94 / var(--tw-bg-opacity)); }
        .border-primary { --tw-border-opacity: 1; border-color: rgb(34 197 94 / var(--tw-border-opacity)); }
        .ring-primary { --tw-ring-opacity: 1; --tw-ring-color: rgb(34 197 94 / var(--tw-ring-opacity)); }
        
        .secondary { --tw-text-opacity: 1; color: rgb(21 128 61 / var(--tw-text-opacity)); }
        .bg-secondary { --tw-bg-opacity: 1; background-color: rgb(21 128 61 / var(--tw-bg-opacity)); }
        
        .accent { --tw-text-opacity: 1; color: rgb(251 146 60 / var(--tw-text-opacity)); }
        .bg-accent { --tw-bg-opacity: 1; background-color: rgb(251 146 60 / var(--tw-bg-opacity)); }
        
        .background { --tw-bg-opacity: 1; background-color: rgb(249 250 251 / var(--tw-bg-opacity)); }
    </style>
</head>
<body class="bg-background text-gray-800 antialiased h-screen overflow-hidden">
    <div class="h-screen bg-gray-50 flex flex-col">
        <!-- Header - Same as Store Page -->
        <header class="flex-shrink-0 bg-white shadow-sm border-b border-gray-200" style="min-height: 8vh; max-height: 10vh;">
            <div class="max-w-md mx-auto flex items-center justify-between" style="height: 8vh; padding: 0 1rem;">
                <!-- Logo Only (Left) -->
                <div class="flex items-center flex-shrink-0">
                    <img src="{{ url_for('static', filename='img/icononly_transparent_nobuffer.png') }}" 
                         alt="Monthly Organics Logo" 
                         class="w-auto"
                         style="height: 5vh; min-height: 32px; max-height: 48px;">
                </div>
                
                <!-- Brand Name with Font Style (Right) -->
                <div class="flex items-center flex-1 justify-end">
                    <img src="{{ url_for('static', filename='img/brand_name_with_font.png') }}" 
                         alt="Monthly Organics" 
                         class="w-auto max-w-full"
                         style="height: 4vh; min-height: 24px; max-height: 36px;">
                </div>
            </div>
        </header>

        <!-- Scrollable Main Content -->
        <div class="flex-1 overflow-y-auto" style="height: calc(100vh - 140px);">
            <div class="max-w-md mx-auto">
                <!-- Page Header with Go Back -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="px-4 py-4">
                        <div class="flex items-center space-x-3 mb-2">
                            <a href="{{ url_for('pre_checkout') }}" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </a>
                            <h1 class="text-lg font-semibold text-gray-900">Delivery Fee Calculation</h1>
                        </div>
                        <p class="text-sm text-gray-600">Review delivery details and calculate fees</p>
                    </div>
                </div>

                <!-- Delivery Address Section -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="font-medium text-gray-900">Delivery Address</h2>
                            <a href="{{ url_for('pre_checkout') }}" class="text-primary text-sm underline hover:no-underline">
                                Change
                            </a>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-3">
                            <h3 class="font-semibold text-gray-900 mb-1">{{ selected_address.nickname }}</h3>
                            <div class="text-sm text-gray-700 space-y-1">
                                <p>{{ selected_address.house_number }}{% if selected_address.block_name %}, {{ selected_address.block_name }}{% endif %}</p>
                                {% if selected_address.floor_door %}<p>{{ selected_address.floor_door }}</p>{% endif %}
                                <p>{{ selected_address.locality }}, {{ selected_address.city }}</p>
                                <p>{{ selected_address.pincode }}</p>
                            </div>
                            <div class="border-t border-gray-200 mt-2 pt-2">
                                <p class="font-semibold text-gray-900">{{ selected_address.receiver_name }}</p>
                                <p class="font-semibold text-gray-900">{{ selected_address.contact_number }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Options Section -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="p-4">
                        <h2 class="font-medium text-gray-900 mb-3">Shipping Options</h2>
                        
                        {% if shipping_options %}
                            <div class="space-y-3">
                                {% for option in shipping_options %}
                                    <div class="border border-gray-200 rounded-lg p-3 hover:border-primary transition-colors">
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" 
                                                   name="shipping_option" 
                                                   value="{{ option.id }}"
                                                   class="text-primary focus:ring-primary"
                                                   {% if option.is_default %}checked{% endif %}
                                                   onchange="updateShippingOption('{{ option.id }}')">
                                            
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="flex items-center space-x-2">
                                                            <h3 class="font-medium text-gray-900">{{ option.name }}</h3>
                                                            {% if option.is_free %}
                                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                                                    FREE
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                        <p class="text-xs text-gray-500 mt-1">
                                                            Delivered by {{ option.delivery_date.strftime('%B %d') }}
                                                            ({{ option.estimated_days }} day{% if option.estimated_days != 1 %}s{% endif %})
                                                        </p>
                                                    </div>
                                                    
                                                    <div class="text-right">
                                                        {% if option.is_free %}
                                                            <span class="text-lg font-bold text-green-600">FREE</span>
                                                        {% else %}
                                                            <span class="text-lg font-bold text-gray-900">â‚¹{{ "%.2f"|format(option.price) }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <p class="text-sm text-gray-500">No shipping options available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Order Summary Section -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="p-4">
                        <h2 class="font-medium text-gray-900 mb-4">Order Summary</h2>
                        
                        <!-- Subtotal -->
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600">Subtotal ({{ cart_count }} items)</span>
                            <span class="font-medium">â‚¹{{ "%.2f"|format(subtotal) }}</span>
                        </div>

                        <!-- Delivery Fee -->
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600">Delivery Fee</span>
                            <span class="font-medium text-green-600" data-delivery-fee>â‚¹{{ "%.2f"|format(delivery_fee) }}</span>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-200 my-3"></div>

                        <!-- Total -->
                        <div class="flex justify-between items-center py-2">
                            <span class="text-lg font-semibold text-gray-900">Total</span>
                            <span class="text-lg font-bold text-green-600" data-total>â‚¹{{ "%.2f"|format(total) }}</span>
                        </div>

                        <!-- Fee Breakdown Note -->
                        <div class="mt-4 p-3 bg-green-50 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="text-sm text-green-700">
                                    <p class="font-medium mb-1">Delivery Fee Details</p>
                                    <p>Delivery fee varies based on your selected shipping option and location.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review and Pay Button -->
                <div class="p-4">
                    <button onclick="proceedToCheckout()" 
                            data-checkout-button
                            class="w-full bg-primary text-white py-4 rounded-lg font-medium text-lg hover:bg-primary/90 transition-colors">
                        Review Products & Pay - â‚¹{{ "%.2f"|format(total) }}
                    </button>
                </div>

                <!-- Spacing for navigation -->
                <div class="h-4"></div>
            </div>
        </div>

        <!-- Mobile Navigation Bar -->
        <nav class="flex-shrink-0 bg-white border-t-2 border-gray-300 md:hidden shadow-lg" style="height: 80px; padding-bottom: 20px; padding-bottom: env(safe-area-inset-bottom, 20px);">
            <div class="max-w-md mx-auto h-full">
                <div class="flex items-center justify-around" style="height: 60px; padding-top: 10px; background: linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%);">
                    <!-- Home -->
                    <a href="/" class="flex flex-col items-center justify-center text-center min-w-0 flex-1 h-full text-gray-500 hover:text-primary transition-colors">
                        <svg class="mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="font-medium text-xs">Home</span>
                    </a>
                    <!-- Store -->
                    <a href="/store" class="flex flex-col items-center justify-center text-center min-w-0 flex-1 h-full text-gray-500 hover:text-primary transition-colors">
                        <svg class="mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <span class="font-medium text-xs">Store</span>
                    </a>
                    <!-- Cart -->
                    <a href="/cart" class="flex flex-col items-center justify-center text-center min-w-0 flex-1 h-full text-primary transition-colors">
                        <svg class="mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m-2.4-5L3 3m0 0h.01M7 13v6a2 2 0 002 2h6a2 2 0 002-2v-6m-8 2h.01M15 15h.01"></path>
                        </svg>
                        <span class="font-medium text-xs">Cart</span>
                    </a>
                    <!-- Profile -->
                    <a href="/profile" class="flex flex-col items-center justify-center text-center min-w-0 flex-1 h-full text-gray-500 hover:text-primary transition-colors">
                        <svg class="mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-xs font-medium">Profile</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>

    <script>
    function updateShippingOption(optionId) {
        // Show loading state
        const deliveryFeeSpan = document.querySelector('[data-delivery-fee]');
        const totalSpan = document.querySelector('[data-total]');
        const checkoutButton = document.querySelector('[data-checkout-button]');
        
        if (deliveryFeeSpan) deliveryFeeSpan.textContent = 'Calculating...';
        if (totalSpan) totalSpan.textContent = 'Calculating...';
        if (checkoutButton) checkoutButton.disabled = true;
        
        // Make API call to update shipping option
        fetch('/update-shipping-option', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                shipping_option_id: optionId,
                address_id: {{ selected_address.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update delivery fee and total
                if (deliveryFeeSpan) {
                    deliveryFeeSpan.textContent = `â‚¹${data.delivery_fee.toFixed(2)}`;
                }
                if (totalSpan) {
                    totalSpan.textContent = `â‚¹${data.total.toFixed(2)}`;
                }
                if (checkoutButton) {
                    checkoutButton.textContent = `Review Products & Pay - â‚¹${data.total.toFixed(2)}`;
                    checkoutButton.disabled = false;
                }
            } else {
                console.error('Error updating shipping option:', data.error);
                if (deliveryFeeSpan) deliveryFeeSpan.textContent = 'Error';
                if (totalSpan) totalSpan.textContent = 'Error';
                if (checkoutButton) checkoutButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            if (deliveryFeeSpan) deliveryFeeSpan.textContent = 'Error';
            if (totalSpan) totalSpan.textContent = 'Error';
            if (checkoutButton) checkoutButton.disabled = false;
        });
    }
    
    function proceedToCheckout() {
        const selectedOption = document.querySelector('input[name="shipping_option"]:checked');
        if (selectedOption) {
            // Store selected shipping option in session or pass as parameter
            window.location.href = `/checkout?address_id={{ selected_address.id }}&shipping_option=${selectedOption.value}`;
        } else {
            window.location.href = `/checkout?address_id={{ selected_address.id }}`;
        }
    }
    </script>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed bottom-4 left-4 right-4 z-50">
                {% for category, message in messages %}
                    <div class="flash-message bg-white rounded-lg shadow-lg border p-4 mb-2 max-w-md mx-auto
                        {% if category == 'error' %}border-red-200{% else %}border-green-200{% endif %}">
                        <div class="flex items-center space-x-2">
                            {% if category == 'error' %}
                                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            {% else %}
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            {% endif %}
                            <span class="text-sm {% if category == 'error' %}text-red-700{% else %}text-green-700{% endif %}">{{ message }}</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Auto-hide flash messages after 3 seconds -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const flashMessages = document.querySelectorAll('.flash-message');
                    flashMessages.forEach(function(message) {
                        setTimeout(function() {
                            message.style.transition = 'opacity 0.5s ease-out';
                            message.style.opacity = '0';
                            setTimeout(function() {
                                message.remove();
                            }, 500);
                        }, 3000);
                    });
                });
            </script>
        {% endif %}
    {% endwith %}

</body>
</html>