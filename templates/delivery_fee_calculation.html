<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Fee Calculation - Monthly Organics</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Calculate delivery fees for your organic produce order - Monthly Organics">
    <meta name="keywords" content="delivery fee, organic produce, checkout, Monthly Organics">
    
    <!-- Favicon and Touch Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}">
    
    <!-- External CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom CSS -->
    <style>
        .primary { --tw-text-opacity: 1; color: rgb(34 197 94 / var(--tw-text-opacity)); }
        .bg-primary { --tw-bg-opacity: 1; background-color: rgb(34 197 94 / var(--tw-bg-opacity)); }
        .border-primary { --tw-border-opacity: 1; border-color: rgb(34 197 94 / var(--tw-border-opacity)); }
        .ring-primary { --tw-ring-opacity: 1; --tw-ring-color: rgb(34 197 94 / var(--tw-ring-opacity)); }
        
        .secondary { --tw-text-opacity: 1; color: rgb(21 128 61 / var(--tw-text-opacity)); }
        .bg-secondary { --tw-bg-opacity: 1; background-color: rgb(21 128 61 / var(--tw-bg-opacity)); }
        
        .accent { --tw-text-opacity: 1; color: rgb(251 146 60 / var(--tw-text-opacity)); }
        .bg-accent { --tw-bg-opacity: 1; background-color: rgb(251 146 60 / var(--tw-bg-opacity)); }
        
        .background { --tw-bg-opacity: 1; background-color: rgb(249 250 251 / var(--tw-bg-opacity)); }
    </style>
</head>
<body class="bg-background text-gray-800 antialiased h-screen overflow-hidden">
    <div class="h-screen bg-gray-50 flex flex-col">
        <!-- Header -->
        <header class="flex-shrink-0 bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-md mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <!-- Logo Section -->
                    <div class="flex items-center space-x-3">
                        <img src="{{ url_for('static', filename='img/icononly_transparent_nobuffer.png') }}" 
                             alt="Monthly Organics" 
                             class="h-8 w-auto max-w-full">
                        <img src="{{ url_for('static', filename='img/Brand name with brand font style.png') }}" 
                             alt="Monthly Organics" 
                             class="h-8 w-auto max-w-full">
                    </div>
                </div>
            </div>
        </header>

        <!-- Scrollable Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-md mx-auto">
                <!-- Page Header with Go Back -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="px-4 py-4">
                        <div class="flex items-center space-x-3 mb-2">
                            <button onclick="window.history.back()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h1 class="text-xl font-bold text-gray-900">Delivery Fee Calculation</h1>
                        </div>
                        <p class="text-sm text-gray-600">Review delivery details and calculate fees</p>
                    </div>
                </div>

                <!-- Delivery Address Section -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="p-4">
                        <h2 class="font-medium text-gray-900 mb-3">Delivery Address</h2>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">{{ selected_address.label }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        {{ selected_address.flat_number }}{% if selected_address.flat_number %}, {% endif %}{{ selected_address.building_name }}{% if selected_address.building_name %},<br>{% endif %}
                                        {{ selected_address.street_address }},<br>
                                        {{ selected_address.area }}, {{ selected_address.city }}<br>
                                        {{ selected_address.state }} - {{ selected_address.pincode }}
                                    </p>
                                </div>
                                <button onclick="editAddress()" class="text-primary text-sm font-medium hover:text-primary/80 transition-colors">
                                    Edit
                                </button>
                            </div>

                            <!-- Receiver Details -->
                            <div class="border-t border-gray-200 pt-3">
                                <p class="text-sm text-gray-600">
                                    <span class="font-medium">Receiver:</span> {{ selected_address.receiver_name }}<br>
                                    <span class="font-medium">Phone:</span> {{ selected_address.receiver_phone }}
                                </p>
                            </div>

                            <!-- Mini Map -->
                            <div class="border-t border-gray-200 pt-3 mt-3">
                                <div id="delivery-mini-map" class="w-full h-32 bg-gray-200 rounded-lg"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Options Section -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="p-4">
                        <h2 class="font-medium text-gray-900 mb-3">Shipping Options</h2>
                        
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-sm text-gray-500">Shipping options will be available soon</p>
                        </div>
                    </div>
                </div>

                <!-- Order Summary Section -->
                <div class="bg-white shadow-sm mb-4">
                    <div class="p-4">
                        <h2 class="font-medium text-gray-900 mb-4">Order Summary</h2>
                        
                        <!-- Subtotal -->
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600">Subtotal ({{ cart_count }} items)</span>
                            <span class="font-medium">₹{{ "%.2f"|format(subtotal) }}</span>
                        </div>

                        <!-- Delivery Fee -->
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600">Delivery Fee</span>
                            <span class="font-medium text-green-600">₹{{ "%.2f"|format(delivery_fee) }}</span>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-200 my-3"></div>

                        <!-- Total -->
                        <div class="flex justify-between items-center py-2">
                            <span class="text-lg font-semibold text-gray-900">Total</span>
                            <span class="text-lg font-bold text-green-600">₹{{ "%.2f"|format(total) }}</span>
                        </div>

                        <!-- Fee Breakdown Note -->
                        <div class="mt-4 p-3 bg-green-50 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="text-sm text-green-700">
                                    <p class="font-medium mb-1">Delivery Fee Details</p>
                                    <p>Based on your location and order value. Free delivery available for orders above ₹500.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review and Pay Button -->
                <div class="p-4">
                    <button onclick="proceedToCheckout()" 
                            class="w-full bg-primary text-white py-4 rounded-lg font-medium text-lg hover:bg-primary/90 transition-colors">
                        Review Products & Pay - ₹{{ "%.2f"|format(total) }}
                    </button>
                </div>

                <!-- Spacing for navigation -->
                <div class="h-4"></div>
            </div>
        </div>

        <!-- Mobile Navigation Bar -->
        <nav class="flex-shrink-0 bg-white border-t border-gray-200 md:hidden">
            <div class="max-w-md mx-auto">
                <div class="flex items-center justify-around py-2">
                    <!-- Home -->
                    <a href="/" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="text-xs font-medium">Home</span>
                    </a>
                    <!-- Store -->
                    <a href="/store" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <span class="text-xs font-medium">Store</span>
                    </a>
                    <!-- Cart -->
                    <a href="/cart" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m-2.4-5L3 3m0 0h.01M7 13v6a2 2 0 002 2h6a2 2 0 002-2v-6m-8 2h.01M15 15h.01"></path>
                        </svg>
                        <span class="text-xs font-medium">Cart</span>
                    </a>
                    <!-- Profile -->
                    <a href="/profile" class="flex flex-col items-center justify-center py-2 px-3 text-center min-w-0 flex-1 text-gray-500 hover:text-primary transition-colors">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-xs font-medium">Profile</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>

    <!-- Include Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>

    <script>
    let deliveryMap = null;

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initDeliveryMap();
    });

    function initDeliveryMap() {
        const mapElement = document.getElementById('delivery-mini-map');
        
        const lat = parseFloat('{{ selected_address.latitude }}');
        const lng = parseFloat('{{ selected_address.longitude }}');
        
        deliveryMap = new google.maps.Map(mapElement, {
            center: { lat: lat, lng: lng },
            zoom: 16,
            disableDefaultUI: true,
            zoomControl: false,
            gestureHandling: 'none' // Disable interaction
        });
        
        // Add marker
        new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: deliveryMap,
            title: 'Delivery Location'
        });
    }

    function editAddress() {
        window.location.href = `/edit-address-for-delivery/{{ selected_address.id }}`;
    }

    function proceedToCheckout() {
        window.location.href = `/checkout?address_id={{ selected_address.id }}`;
    }
    </script>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed bottom-4 left-4 right-4 z-50">
                {% for category, message in messages %}
                    <div class="bg-white rounded-lg shadow-lg border p-4 mb-2 max-w-md mx-auto
                        {% if category == 'error' %}border-red-200{% else %}border-green-200{% endif %}">
                        <div class="flex items-center space-x-2">
                            {% if category == 'error' %}
                                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            {% else %}
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            {% endif %}
                            <span class="text-sm {% if category == 'error' %}text-red-700{% else %}text-green-700{% endif %}">{{ message }}</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

</body>
</html>