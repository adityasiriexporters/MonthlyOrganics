{% extends "base.html" %}

{% block title %}Add New Address - Monthly Organics{% endblock %}

{% block extra_head %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
<style>
    #map {
        height: 100%;
        width: 100%;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    /* Prevent body scroll when modal is open */
    body.modal-open {
        overflow: hidden;
    }
    /* Map modal specific styles */
    #mapModal {
        touch-action: none;
    }
    #mapModal #map {
        padding-top: 80px; /* Account for header */
        padding-bottom: 200px; /* Account for controls + mobile nav */
    }
    /* Map controls positioning */
    .map-controls {
        bottom: 80px; /* Above mobile navigation bar */
    }
    @media (min-width: 768px) {
        .map-controls {
            bottom: 20px; /* Normal position on desktop */
        }
        #mapModal #map {
            padding-bottom: 160px; /* Less padding on desktop */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto px-4 py-6 bg-gray-50 min-h-full">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Add New Address</h1>
            <p class="text-gray-600 text-sm mt-1">Please provide your delivery address details</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Open Map Button -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Select Location</h3>
                <button id="changeLocationBtn" class="text-primary hover:text-primary/80 text-sm font-medium hidden">
                    Change
                </button>
            </div>
            
            <!-- Location Status Display -->
            <div id="locationDisplay" class="mb-4 hidden">
                <div class="flex items-center space-x-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <div>
                        <div class="text-sm font-medium text-green-800">Location Selected</div>
                        <div id="selectedLocationDisplay" class="text-xs text-green-600"></div>
                    </div>
                </div>
            </div>
            
            <!-- Open Map Button -->
            <button id="openMapBtn" 
                    class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Select Location on Map</span>
            </button>
        </div>

        <!-- Selected Location Map Display -->
        <div id="selectedLocationMap" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Selected Location</h3>
            <div id="miniMap" style="height: 200px; width: 100%; border-radius: 8px;"></div>
            <div class="mt-3 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span id="selectedLocationText">Location confirmed</span>
                </div>
                <button type="button" onclick="openMapModal()" class="text-primary hover:text-primary/80 text-sm font-medium">
                    Change Location
                </button>
            </div>
        </div>

        <!-- Address Form -->
        <form id="addressForm" method="POST" action="{{ url_for('save_address') }}" 
              class="space-y-6" style="display: none;">
            
            <!-- Hidden Map Data -->
            <input type="hidden" id="latitude" name="latitude" value="0">
            <input type="hidden" id="longitude" name="longitude" value="0">
            
            <!-- Address Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Details</h3>
                
                <div class="space-y-4">
                    <!-- House Number (Required) -->
                    <div>
                        <label for="house_number" class="block text-sm font-medium text-gray-700 required-field">
                            House No/Plot No/Building/Community Name
                        </label>
                        <input type="text" id="house_number" name="house_number" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Block Name (Optional) -->
                    <div>
                        <label for="block_name" class="block text-sm font-medium text-gray-700">
                            Block Name/No
                        </label>
                        <input type="text" id="block_name" name="block_name"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Floor/Door (Required) -->
                    <div>
                        <label for="floor_door" class="block text-sm font-medium text-gray-700 required-field">
                            Floor/Door Number
                        </label>
                        <input type="text" id="floor_door" name="floor_door" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Locality (Required, Auto-filled) -->
                    <div>
                        <label for="locality" class="block text-sm font-medium text-gray-700 required-field">
                            Locality
                        </label>
                        <input type="text" id="locality" name="locality" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- City (Auto-filled, Non-editable) -->
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">
                            City
                        </label>
                        <input type="text" id="city" name="city" readonly
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- Pincode (Auto-filled, Non-editable) -->
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">
                            Pincode
                        </label>
                        <input type="text" id="pincode" name="pincode" readonly
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- Nearby Landmark (Optional) -->
                    <div>
                        <label for="nearby_landmark" class="block text-sm font-medium text-gray-700">
                            Nearby Landmark
                        </label>
                        <input type="text" id="nearby_landmark" name="nearby_landmark"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>

            <!-- Address Label Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 required-field">Address Label</h3>
                
                <div class="space-y-4">
                    <!-- Manual Label Input -->
                    <div>
                        <label for="nickname" class="block text-sm font-medium text-gray-700 required-field">
                            Enter Address Label
                        </label>
                        <input type="text" id="nickname" name="nickname" required
                               placeholder="e.g., Home, Office, Friend's Place, etc."
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>

            <!-- Receiver Details Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Receiver Details</h3>
                
                <div class="space-y-4">
                    <!-- Receiver Name (Required) -->
                    <div>
                        <label for="receiver_name" class="block text-sm font-medium text-gray-700 required-field">
                            Receiver's Name
                        </label>
                        <div class="mt-1 relative">
                            <input type="text" id="receiver_name" name="receiver_name" required
                                   class="block w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:ring-primary focus:border-primary">
                            <button type="button" id="contactsBtn" 
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Receiver Phone (Required) -->
                    <div>
                        <label for="contact_number" class="block text-sm font-medium text-gray-700 required-field">
                            Receiver's Phone Number
                        </label>
                        <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10}" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Address Notes -->
                    <div>
                        <label for="address_notes" class="block text-sm font-medium text-gray-700">
                            Address Notes (Optional)
                        </label>
                        <textarea id="address_notes" name="address_notes" rows="3" 
                                  class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary"
                                  placeholder="Any additional delivery instructions..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <button type="submit" 
                        class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                    Save Address
                </button>
            </div>
        </form>
</div>

<!-- Full Screen Map Modal -->
<div id="mapModal" class="fixed inset-0 bg-white z-50 hidden overflow-hidden">
    <!-- Map Header -->
    <div class="absolute top-0 left-0 right-0 bg-white shadow-sm border-b border-gray-200 z-10">
        <div class="flex items-center justify-between p-4">
            <h3 class="text-lg font-semibold text-gray-900">Select Location</h3>
            <button id="closeMapBtn" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Full Screen Map -->
    <div id="map" class="w-full h-full"></div>
    
    <!-- Map Controls - Fixed at bottom -->
    <div class="absolute left-0 right-0 bg-white shadow-lg border-t border-gray-200 p-4 z-10 map-controls">
        <!-- Location Status -->
        <div id="locationStatus" class="text-sm text-gray-600 mb-4 text-center">
            Tap on the map to select your location or use current location
        </div>
        
        <!-- Control Buttons -->
        <div class="flex space-x-2">
            <button id="getCurrentLocation" 
                    class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Use Current Location</span>
            </button>
            <button id="confirmLocation" 
                    class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2" 
                    disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Confirm Location</span>
            </button>
        </div>
    </div>
</div>

<!-- Location Confirmation Modal -->
<div id="locationConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Location</h3>
            <div id="selectedLocationText" class="text-sm text-gray-600 mb-6"></div>
            <div class="flex space-x-3">
                <button id="cancelLocationConfirm" 
                        class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="confirmLocationFinal" 
                        class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map;
let marker;
let geocoder;
let miniMap;
let miniMarker;
let selectedLocation = null;
let existingAddresses = [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    loadExistingAddresses();
});

function initMap() {
    // Default to Hyderabad coordinates
    const hyderabadCoords = { lat: 17.385044, lng: 78.486671 };
    
    // Create map
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: hyderabadCoords,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        gestureHandling: 'greedy', // Allow scrolling/zooming without modifier keys
        disableDefaultUI: true,
        zoomControl: true,
        zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_CENTER
        }
    });
    
    // Initialize geocoder
    geocoder = new google.maps.Geocoder();
    
    // Add click listener for map
    map.addListener('click', function(e) {
        setMarker(e.latLng);
    });
    
    // Trigger resize after map is initialized
    setTimeout(() => {
        google.maps.event.trigger(map, 'resize');
    }, 100);
}

function setMarker(location) {
    // Remove existing marker
    if (marker) {
        marker.setMap(null);
    }
    
    // Create new marker
    marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true,
        animation: google.maps.Animation.DROP
    });
    
    // Add drag listener
    marker.addListener('dragend', function(e) {
        setMarker(e.latLng);
    });
    
    // Update location data
    selectedLocation = location;
    document.getElementById('latitude').value = location.lat();
    document.getElementById('longitude').value = location.lng();
    
    // Enable confirm button
    const confirmBtn = document.getElementById('confirmLocation');
    confirmBtn.disabled = false;
    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    
    // Update status
    document.getElementById('locationStatus').textContent = 'Location selected. Tap "Confirm Location" to proceed.';
    
    console.log('Location selected:', location.lat(), location.lng());
    
    // Reverse geocode to get address
    reverseGeocode(location);
}

function reverseGeocode(location) {
    geocoder.geocode({ location: location }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const addressComponents = results[0].address_components;
            const formattedAddress = results[0].formatted_address;
            
            // Extract address components with better fallback logic
            let locality = '';
            let city = '';
            let pincode = '';
            
            for (let component of addressComponents) {
                const types = component.types;
                
                // For locality - try multiple types
                if (types.includes('sublocality_level_1') || 
                    types.includes('sublocality_level_2') || 
                    types.includes('locality')) {
                    if (!locality) locality = component.long_name;
                }
                
                // For city - try multiple administrative levels
                if (types.includes('administrative_area_level_2') || 
                    types.includes('administrative_area_level_3') ||
                    types.includes('locality')) {
                    if (!city) city = component.long_name;
                }
                
                // For pincode
                if (types.includes('postal_code')) {
                    pincode = component.long_name;
                }
            }
            
            // Fallback: if city is still empty, use locality
            if (!city && locality) {
                city = locality;
            }
            
            // Update confirmation modal text
            document.getElementById('selectedLocationText').textContent = formattedAddress;
            
            // Pre-fill form fields (will be populated when location is confirmed)
            window.pendingLocationData = {
                locality: locality,
                city: city,
                pincode: pincode,
                formattedAddress: formattedAddress
            };
            
            console.log('Geocoding result:', { locality, city, pincode, formattedAddress });
        } else {
            console.error('Geocoding failed:', status);
            document.getElementById('locationStatus').textContent = 'Unable to get address details. You can enter them manually.';
        }
    });
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        document.getElementById('locationStatus').textContent = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const location = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                
                map.setCenter(location);
                map.setZoom(16);
                setMarker(location);
            },
            function(error) {
                document.getElementById('locationStatus').textContent = 'Unable to access location. Please tap on the map to select.';
                console.error('Geolocation error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        document.getElementById('locationStatus').textContent = 'Location not supported. Please tap on the map to select.';
    }
}

function openMapModal() {
    // Show modal
    document.getElementById('mapModal').classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Initialize map if not already done
    if (!map) {
        initMap();
    } else {
        // Trigger resize if map already exists
        setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            if (selectedLocation) {
                map.setCenter(selectedLocation);
            }
        }, 100);
    }
}

function closeMapModal() {
    document.getElementById('mapModal').classList.add('hidden');
    document.body.classList.remove('modal-open');
}

function confirmLocationSelection() {
    if (selectedLocation) {
        document.getElementById('locationConfirmModal').classList.remove('hidden');
    }
}

function setupEventListeners() {
    // Open map button
    document.getElementById('openMapBtn').addEventListener('click', openMapModal);
    
    // Close map button
    document.getElementById('closeMapBtn').addEventListener('click', closeMapModal);
    
    // Get current location button
    document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);
    
    // Confirm location button
    document.getElementById('confirmLocation').addEventListener('click', confirmLocationSelection);
    
    // Location confirmation modal buttons
    document.getElementById('cancelLocationConfirm').addEventListener('click', function() {
        document.getElementById('locationConfirmModal').classList.add('hidden');
    });
    
    document.getElementById('confirmLocationFinal').addEventListener('click', function() {
        // Hide modals
        document.getElementById('locationConfirmModal').classList.add('hidden');
        closeMapModal();
        
        // Show location display
        document.getElementById('locationDisplay').classList.remove('hidden');
        document.getElementById('selectedLocationDisplay').textContent = window.pendingLocationData?.formattedAddress || 'Selected location';
        
        // Hide open map button, show change button
        document.getElementById('openMapBtn').style.display = 'none';
        document.getElementById('changeLocationBtn').classList.remove('hidden');
        
        // Populate form fields
        if (window.pendingLocationData) {
            document.getElementById('locality').value = window.pendingLocationData.locality;
            document.getElementById('city').value = window.pendingLocationData.city;
            document.getElementById('pincode').value = window.pendingLocationData.pincode;
        }
        
        // Show mini map and form
        showMiniMap();
        document.getElementById('addressForm').style.display = 'block';
        
        // Scroll to form
        setTimeout(() => {
            document.getElementById('addressForm').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    });
    
    // Change location button
    document.getElementById('changeLocationBtn').addEventListener('click', function() {
        // Hide form and location display
        document.getElementById('addressForm').style.display = 'none';
        document.getElementById('locationDisplay').classList.add('hidden');
        
        // Show open map button, hide change button
        document.getElementById('openMapBtn').style.display = 'block';
        document.getElementById('changeLocationBtn').classList.add('hidden');
        
        // Clear form data
        document.getElementById('addressForm').reset();
        
        // Clear location data and hide mini map
        selectedLocation = null;
        window.pendingLocationData = null;
        document.getElementById('latitude').value = '0';
        document.getElementById('longitude').value = '0';
        document.getElementById('selectedLocationMap').classList.add('hidden');
        
        // Reset confirm button
        document.getElementById('confirmLocation').disabled = true;
        document.getElementById('confirmLocation').classList.add('opacity-50', 'cursor-not-allowed');
    });
    
    // Contacts button (placeholder for now)
    if (document.getElementById('contactsBtn')) {
        document.getElementById('contactsBtn').addEventListener('click', function() {
            alert('Contact selection feature will be available soon!');
        });
    }
    
    // Prevent modal close on map interaction
    document.getElementById('mapModal').addEventListener('click', function(e) {
        e.stopPropagation();
    });
}

// Update nickname when custom label changes
function updateNickname() {
    const customLabelInput = document.getElementById('custom_label');
    const nicknameInput = document.getElementById('nickname');
    
    if (customLabelInput && nicknameInput) {
        nicknameInput.value = customLabelInput.value;
    }
}

// Update nickname when custom label changes
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('custom_label')) {
        document.getElementById('custom_label').addEventListener('input', updateNickname);
    }
});

// Form submission validation
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('addressForm')) {
        document.getElementById('addressForm').addEventListener('submit', function(e) {
            const customLabel = document.getElementById('custom_label').value.trim();
            
            if (!customLabel) {
                e.preventDefault();
                alert('Please enter an address label.');
                return;
            }
            
            // Update nickname field with the custom label value
            document.getElementById('nickname').value = customLabel;
        });
    }
});

// Mini Map Functions
function showMiniMap() {
    if (selectedLocation) {
        const mapContainer = document.getElementById('selectedLocationMap');
        mapContainer.classList.remove('hidden');
        
        // Store coordinates for form submission
        document.getElementById('latitude').value = selectedLocation.lat();
        document.getElementById('longitude').value = selectedLocation.lng();
        
        // Initialize mini map
        setTimeout(() => {
            miniMap = new google.maps.Map(document.getElementById('miniMap'), {
                zoom: 15,
                center: selectedLocation,
                disableDefaultUI: true,
                gestureHandling: 'none', // Disable interaction
                clickableIcons: false
            });
            
            // Add marker to mini map
            miniMarker = new google.maps.Marker({
                position: selectedLocation,
                map: miniMap,
                icon: {
                    url: 'data:image/svg+xml,' + encodeURIComponent(`
                        <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="8" fill="#ef4444" stroke="#ffffff" stroke-width="2"/>
                            <circle cx="15" cy="15" r="3" fill="#ffffff"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(30, 30),
                    anchor: new google.maps.Point(15, 15)
                }
            });
        }, 100);
        
        // Update location text
        const locationText = document.getElementById('selectedLocationText');
        if (window.pendingLocationData?.formattedAddress) {
            locationText.textContent = window.pendingLocationData.formattedAddress;
        } else {
            locationText.textContent = `${selectedLocation.lat().toFixed(6)}, ${selectedLocation.lng().toFixed(6)}`;
        }
    }
}

// Load existing addresses for incremental naming
function loadExistingAddresses() {
    fetch('/api/addresses', {
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        existingAddresses = data.addresses || [];
        console.log('Loaded existing addresses:', existingAddresses);
    })
    .catch(error => {
        console.error('Error loading existing addresses:', error);
        existingAddresses = [];
    });
}

// Generate incremental address label
function generateIncrementalLabel(baseLabel) {
    if (!existingAddresses || existingAddresses.length === 0) {
        return baseLabel;
    }
    
    // Count existing labels with the same base
    const baseLabelLower = baseLabel.toLowerCase();
    let maxNumber = 0;
    let hasBase = false;
    
    existingAddresses.forEach(address => {
        const nickname = address.nickname.toLowerCase();
        
        if (nickname === baseLabelLower) {
            hasBase = true;
        } else if (nickname.startsWith(baseLabelLower + ' ')) {
            // Extract number from labels like "My Home 2", "Work 3", etc.
            const numberPart = nickname.substring(baseLabelLower.length + 1);
            const number = parseInt(numberPart);
            if (!isNaN(number) && number > maxNumber) {
                maxNumber = number;
            }
        }
    });
    
    // If base label exists, start numbering
    if (hasBase || maxNumber > 0) {
        return baseLabel + ' ' + (maxNumber + 1);
    }
    
    return baseLabel;
}
</script>
{% endblock %}