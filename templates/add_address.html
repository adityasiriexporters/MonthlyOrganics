{% extends "base.html" %}

{% block title %}Add New Address - Monthly Organics{% endblock %}

{% block extra_head %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
<style>
    #map {
        height: 200px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pb-20 md:pb-0 bg-gray-50">
    <div class="max-w-md mx-auto px-4 py-6">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Add New Address</h1>
            <p class="text-gray-600 text-sm mt-1">Please provide your delivery address details</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Location Map Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Select Location</h3>
                <button id="changeLocationBtn" class="text-primary hover:text-primary/80 text-sm font-medium hidden">
                    Change
                </button>
            </div>
            
            <!-- Map Container -->
            <div id="map" class="mb-4"></div>
            
            <!-- Location Status -->
            <div id="locationStatus" class="text-sm text-gray-500 mb-4">
                Click on the map to select your location or allow location access
            </div>
            
            <!-- Location Controls -->
            <div class="flex space-x-2">
                <button id="getCurrentLocation" 
                        class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors">
                    Use Current Location
                </button>
                <button id="confirmLocation" 
                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" 
                        disabled>
                    Confirm Location
                </button>
            </div>
        </div>

        <!-- Address Form -->
        <form id="addressForm" method="POST" action="{{ url_for('save_address') }}" 
              class="space-y-6" style="display: none;">
            
            <!-- Hidden Map Data -->
            <input type="hidden" id="latitude" name="latitude" value="0">
            <input type="hidden" id="longitude" name="longitude" value="0">
            
            <!-- Address Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Details</h3>
                
                <div class="space-y-4">
                    <!-- House Number (Required) -->
                    <div>
                        <label for="house_number" class="block text-sm font-medium text-gray-700 required-field">
                            House No/Plot No/Building/Community Name
                        </label>
                        <input type="text" id="house_number" name="house_number" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Block Name (Optional) -->
                    <div>
                        <label for="block_name" class="block text-sm font-medium text-gray-700">
                            Block Name/No
                        </label>
                        <input type="text" id="block_name" name="block_name"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Floor/Door (Required) -->
                    <div>
                        <label for="floor_door" class="block text-sm font-medium text-gray-700 required-field">
                            Floor/Door Number
                        </label>
                        <input type="text" id="floor_door" name="floor_door" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Locality (Required, Auto-filled) -->
                    <div>
                        <label for="locality" class="block text-sm font-medium text-gray-700 required-field">
                            Locality
                        </label>
                        <input type="text" id="locality" name="locality" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- City (Auto-filled, Non-editable) -->
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">
                            City
                        </label>
                        <input type="text" id="city" name="city" readonly
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- Pincode (Auto-filled, Non-editable) -->
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">
                            Pincode
                        </label>
                        <input type="text" id="pincode" name="pincode" readonly
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">Auto-filled from map location</p>
                    </div>
                    
                    <!-- Nearby Landmark (Optional) -->
                    <div>
                        <label for="nearby_landmark" class="block text-sm font-medium text-gray-700">
                            Nearby Landmark
                        </label>
                        <input type="text" id="nearby_landmark" name="nearby_landmark"
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>

            <!-- Address Label Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 required-field">Address Label</h3>
                
                <div class="space-y-4">
                    <!-- Predefined Labels -->
                    <div class="flex space-x-2">
                        <label class="flex-1">
                            <input type="radio" name="label_type" value="home" class="sr-only" onchange="toggleCustomLabel()">
                            <div class="border border-gray-300 rounded-lg px-4 py-3 text-center cursor-pointer hover:bg-primary/5 transition-colors radio-option">
                                <span class="text-sm font-medium">My Home</span>
                            </div>
                        </label>
                        <label class="flex-1">
                            <input type="radio" name="label_type" value="other" class="sr-only" onchange="toggleCustomLabel()">
                            <div class="border border-gray-300 rounded-lg px-4 py-3 text-center cursor-pointer hover:bg-primary/5 transition-colors radio-option">
                                <span class="text-sm font-medium">Others</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Custom Label Input -->
                    <div id="customLabelDiv" class="hidden">
                        <input type="text" id="custom_label" name="custom_label" placeholder="Enter custom label"
                               class="block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Hidden nickname field that gets populated -->
                    <input type="hidden" id="nickname" name="nickname" value="">
                </div>
            </div>

            <!-- Receiver Details Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Receiver Details</h3>
                
                <div class="space-y-4">
                    <!-- Receiver Name -->
                    <div>
                        <label for="receiver_name" class="block text-sm font-medium text-gray-700">
                            Receiver's Name
                        </label>
                        <div class="mt-1 relative">
                            <input type="text" id="receiver_name" name="receiver_name"
                                   class="block w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:ring-primary focus:border-primary">
                            <button type="button" id="contactsBtn" 
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Receiver Phone -->
                    <div>
                        <label for="contact_number" class="block text-sm font-medium text-gray-700">
                            Receiver's Phone Number
                        </label>
                        <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10}" 
                               class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- Address Notes -->
                    <div>
                        <label for="address_notes" class="block text-sm font-medium text-gray-700">
                            Address Notes (Optional)
                        </label>
                        <textarea id="address_notes" name="address_notes" rows="3" 
                                  class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary focus:border-primary"
                                  placeholder="Any additional delivery instructions..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <button type="submit" 
                        class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                    Save Address
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Location Confirmation Modal -->
<div id="locationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Location</h3>
            <div id="selectedLocationText" class="text-sm text-gray-600 mb-6"></div>
            <div class="flex space-x-3">
                <button id="cancelLocation" 
                        class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="confirmLocationFinal" 
                        class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map;
let marker;
let geocoder;
let selectedLocation = null;

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    setupEventListeners();
});

function initMap() {
    // Default to Hyderabad coordinates
    const hyderabadCoords = { lat: 17.385044, lng: 78.486671 };
    
    // Create map
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: hyderabadCoords,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
    });
    
    // Initialize geocoder
    geocoder = new google.maps.Geocoder();
    
    // Add click listener for map
    map.addListener('click', function(e) {
        setMarker(e.latLng);
    });
}

function setMarker(location) {
    // Remove existing marker
    if (marker) {
        marker.setMap(null);
    }
    
    // Create new marker
    marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true
    });
    
    // Add drag listener
    marker.addListener('dragend', function(e) {
        setMarker(e.latLng);
    });
    
    // Update location data
    selectedLocation = location;
    document.getElementById('latitude').value = location.lat();
    document.getElementById('longitude').value = location.lng();
    
    // Enable confirm button
    document.getElementById('confirmLocation').disabled = false;
    
    // Update status
    document.getElementById('locationStatus').textContent = 'Location selected. Click "Confirm Location" to continue.';
    
    // Reverse geocode to get address
    reverseGeocode(location);
}

function reverseGeocode(location) {
    geocoder.geocode({ location: location }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const addressComponents = results[0].address_components;
            const formattedAddress = results[0].formatted_address;
            
            // Extract address components
            let locality = '';
            let city = '';
            let pincode = '';
            
            for (let component of addressComponents) {
                if (component.types.includes('sublocality_level_1') || component.types.includes('locality')) {
                    locality = component.long_name;
                }
                if (component.types.includes('administrative_area_level_2')) {
                    city = component.long_name;
                }
                if (component.types.includes('postal_code')) {
                    pincode = component.long_name;
                }
            }
            
            // Update modal text
            document.getElementById('selectedLocationText').textContent = formattedAddress;
            
            // Pre-fill form fields
            document.getElementById('locality').value = locality;
            document.getElementById('city').value = city;
            document.getElementById('pincode').value = pincode;
        }
    });
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        document.getElementById('locationStatus').textContent = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                map.setCenter(location);
                setMarker(location);
            },
            function(error) {
                document.getElementById('locationStatus').textContent = 'Unable to get location. Please select manually on the map.';
                console.error('Geolocation error:', error);
            }
        );
    } else {
        document.getElementById('locationStatus').textContent = 'Geolocation not supported. Please select manually on the map.';
    }
}

function setupEventListeners() {
    // Get current location button
    document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);
    
    // Confirm location button
    document.getElementById('confirmLocation').addEventListener('click', function() {
        if (selectedLocation) {
            document.getElementById('locationModal').classList.remove('hidden');
        }
    });
    
    // Modal buttons
    document.getElementById('cancelLocation').addEventListener('click', function() {
        document.getElementById('locationModal').classList.add('hidden');
    });
    
    document.getElementById('confirmLocationFinal').addEventListener('click', function() {
        document.getElementById('locationModal').classList.add('hidden');
        
        // Show the form
        document.getElementById('addressForm').style.display = 'block';
        
        // Show change button
        document.getElementById('changeLocationBtn').classList.remove('hidden');
        
        // Update map to smaller size
        document.getElementById('map').style.height = '150px';
        
        // Update status
        document.getElementById('locationStatus').textContent = 'Location confirmed. Fill in the address details below.';
        
        // Scroll to form
        document.getElementById('addressForm').scrollIntoView({ behavior: 'smooth' });
    });
    
    // Change location button
    document.getElementById('changeLocationBtn').addEventListener('click', function() {
        // Hide form
        document.getElementById('addressForm').style.display = 'none';
        
        // Hide change button
        document.getElementById('changeLocationBtn').classList.add('hidden');
        
        // Reset map size
        document.getElementById('map').style.height = '200px';
        
        // Update status
        document.getElementById('locationStatus').textContent = 'Click on the map to select your location or allow location access';
        
        // Clear form
        document.getElementById('addressForm').reset();
        
        // Scroll to map
        document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
    });
    
    // Contacts button (placeholder for now)
    document.getElementById('contactsBtn').addEventListener('click', function() {
        alert('Contact selection feature will be available soon!');
    });
}

function toggleCustomLabel() {
    const labelType = document.querySelector('input[name="label_type"]:checked').value;
    const customLabelDiv = document.getElementById('customLabelDiv');
    const customLabelInput = document.getElementById('custom_label');
    const nicknameInput = document.getElementById('nickname');
    
    // Update radio button appearance
    document.querySelectorAll('.radio-option').forEach(option => {
        option.classList.remove('border-primary', 'bg-primary/5');
        option.classList.add('border-gray-300');
    });
    
    const selectedOption = document.querySelector('input[name="label_type"]:checked').parentElement.querySelector('.radio-option');
    selectedOption.classList.remove('border-gray-300');
    selectedOption.classList.add('border-primary', 'bg-primary/5');
    
    if (labelType === 'other') {
        customLabelDiv.classList.remove('hidden');
        customLabelInput.required = true;
        nicknameInput.value = '';
    } else {
        customLabelDiv.classList.add('hidden');
        customLabelInput.required = false;
        customLabelInput.value = '';
        nicknameInput.value = labelType === 'home' ? 'My Home' : '';
    }
}

// Update nickname when custom label changes
document.getElementById('custom_label').addEventListener('input', function() {
    document.getElementById('nickname').value = this.value;
});

// Form submission validation
document.getElementById('addressForm').addEventListener('submit', function(e) {
    const nickname = document.getElementById('nickname').value;
    const labelType = document.querySelector('input[name="label_type"]:checked');
    
    if (!labelType) {
        e.preventDefault();
        alert('Please select an address label.');
        return;
    }
    
    if (labelType.value === 'other' && !nickname) {
        e.preventDefault();
        alert('Please enter a custom label.');
        return;
    }
    
    if (labelType.value === 'home') {
        document.getElementById('nickname').value = 'My Home';
    }
});
</script>
{% endblock %}