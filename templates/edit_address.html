{% extends "base.html" %}

{% block title %}Edit Address - Monthly Organics{% endblock %}

{% block content %}
<div class="min-h-screen pb-20 md:pb-0 bg-gray-50">
    <div class="max-w-md mx-auto px-4 py-6">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('addresses') }}" class="text-gray-600 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-2xl font-bold text-gray-900">Edit Address</h1>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Mini Map Display -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Current Location</h3>
                <div id="miniMap" class="h-40 w-full rounded-lg bg-gray-100 overflow-hidden"></div>
                <div class="mt-2 text-sm text-gray-600">
                    <p>{{ address.locality }}, {{ address.city }} - {{ address.pincode }}</p>
                </div>
            </div>
        </div>

        <!-- Edit Address Form -->
        <form method="POST" action="{{ url_for('update_address', address_id=address.id) }}" class="space-y-4">
            <!-- Hidden fields for location -->
            <input type="hidden" name="latitude" value="{{ address.latitude }}">
            <input type="hidden" name="longitude" value="{{ address.longitude }}">
            <input type="hidden" name="locality" value="{{ address.locality }}">
            <input type="hidden" name="city" value="{{ address.city }}">
            <input type="hidden" name="pincode" value="{{ address.pincode }}">

            <!-- Address Details -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Details</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">House/Flat/Plot Number *</label>
                        <input type="text" name="house_number" value="{{ address.house_number }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Block/Building Name</label>
                        <input type="text" name="block_name" value="{{ address.block_name or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Floor/Door Number *</label>
                    <input type="text" name="floor_door" value="{{ address.floor_door }}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nearby Landmark (Optional)</label>
                    <input type="text" name="nearby_landmark" value="{{ address.nearby_landmark or '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
            </div>

            <!-- Contact Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Receiver Name *</label>
                        <input type="text" name="receiver_name" value="{{ address.receiver_name or 'Customer' }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number *</label>
                        <input type="tel" name="contact_number" value="{{ address.contact_number }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                </div>
            </div>

            <!-- Address Label -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Label</h3>
                
                <input type="text" name="nickname" value="{{ address.nickname }}" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                       placeholder="Enter address label">
            </div>

            <!-- Additional Notes -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Additional Notes (Optional)</h3>
                <textarea name="address_notes" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"
                          placeholder="Any additional delivery instructions...">{{ address.address_notes or '' }}</textarea>
            </div>

            <!-- Set as Default -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <label class="flex items-center space-x-3">
                    <input type="checkbox" name="is_default" value="1" {% if address.is_default %}checked{% endif %}
                           class="h-4 w-4 text-primary focus:ring-primary/50 border-gray-300 rounded">
                    <span class="text-sm font-medium text-gray-700">Set as default address</span>
                </label>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4 pt-4">
                <button type="submit" 
                        class="flex-1 bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                    Update Address
                </button>
                <a href="{{ url_for('addresses') }}" 
                   class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-200 transition-colors text-center font-medium">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize mini map
function initMiniMap() {
    const lat = parseFloat('{{ address.latitude }}');
    const lng = parseFloat('{{ address.longitude }}');
    
    const map = new google.maps.Map(document.getElementById('miniMap'), {
        center: { lat: lat, lng: lng },
        zoom: 15,
        disableDefaultUI: true,
        zoomControl: true,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });

    // Add marker
    new google.maps.Marker({
        position: { lat: lat, lng: lng },
        map: map,
        icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="#10b981" stroke="#059669" stroke-width="2"/>
                    <circle cx="12" cy="10" r="3" fill="white"/>
                </svg>
            `),
            scaledSize: new google.maps.Size(24, 24),
            anchor: new google.maps.Point(12, 24)
        }
    });
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (typeof google !== 'undefined' && google.maps) {
        initMiniMap();
    } else {
        // Wait for Google Maps to load
        window.initMiniMap = initMiniMap;
    }
});
</script>
{% endblock %}